/* Copyright 2018 Yuki Rea <null-src.com>
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

#include QMK_KEYBOARD_H
#define _______ KC_TRNS               // Transparent key 
#define xxxxxxx KC_NO                 // Disable key
#define SHFTHEX LT(1, KC_PENT)        // Tap = Enter | Hold = HEX keypad layer
#define FN1_APP LT(10, KC_APP)         // Tap = App Menu | Hold = Function layer 1
#define CAPS_FN LT(11, KC_CAPS)
#define DM_STOP DYN_REC_STOP          // Stop dynamic macro recording
#define DM_REC1 DYN_REC_START1        // Record dynamic macro 1
#define DM_REC2 DYN_REC_START2        // Record dynamic macro 2
#define DM_PLY1 DYN_MACRO_PLAY1       // Play dynamic macro 1
#define DM_PLY2 DYN_MACRO_PLAY2       // Play dynamic macro 2
#define SAFECAP LSFT(KC_CAPS)

#define led_on_helper(port, pin) DDR ## port |=  (1<<pin); PORT ## port |=  (1<<pin)
#define led_on(x) led_on_helper(x)
#define led_off_helper(port, pin) DDR ## port &=  ~(1<<pin); PORT ## port &=  ~(1<<pin)
#define led_off(x) led_off_helper(x)

// LED pin definition 
#define fn_led		D,4
#define keypad_led	B,4
#define scroll_led	B,6
#define num_led		B,5
#define caps_led	D,7
#define kana_led	D,5
#define meta_led	D,6
#define left_led	B,7
#define center_led	D,0
#define right_led	D,1
#define sleep_led	right_led

uint16_t load_animation_counter = 0;
uint16_t unload_animation_counter = 0;

static bool keypad_led_animation = false;
static bool caps_led_animation = false;
static bool fn_led_animation = false;
static bool load_led_animation = false;
static bool unload_led_animation = false;
static bool unload_led_animation_start = false;

// Defines the keycodes used by our macros in process_record_user
enum custom_keycodes {
  HEXA = SAFE_RANGE,                  // HEX keypad - A
  HEXB,                               // HEX keypad - B
  HEXC,                               // HEX keypad - C
  HEXD,                               // HEX keypad - D
  HEXE,                               // HEX keypad - C
  HEXF,                               // HEX keypad - F
  HEXX,                               // HEX keypad - x
  SW_LEFT,                            // Switch left  monitor input
  SW_RGHT,                            // Switch right monitor input
  SW_BOTH,                            // Switch both  monitor inputs
  MS_K_UL,
  EEPROMR,
  EEPROMW,
  DYNAMIC_MACRO_RANGE,                // Dynamic macro recording
};

#include "dynamic_macro.h"
#include "mousekey.h"
#include "eeprom.h"


/*
void run_led_animation(const uint16_t table, int led_count, ...) {
  va_list leds;
  va_start(leds, )
}
*/

const uint16_t PROGMEM keymaps[][MATRIX_ROWS][MATRIX_COLS] = {


  /* -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
  // Blank layout template
  ,---------------------------------------------------------------------------------------------------------------------------------------------. 
  | ,-----.     ,-----------------------.  ,-----------------------.  ,-----------------------.  ,-----------------.                            | 
  | |     |     |     |     |     |     |  |     |     |     |     |  |     |     |     |     |  |     |     |     |                            | 
  | `-----'     `-----------------------'  `-----------------------'  `-----------------------'  `-----------------'           O     O     O    | 
  | ,-----------------------------------------------------------------------------------------.  ,-----------------.  ,-----------------------. | 
  | |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |  |     |     |     |  |     |     |     |     | | 
  | |-----------------------------------------------------------------------------------------|  |-----------------|  |-----------------------| | 
  | |       |     |     |     |     |     |     |     |     |     |     |     |     |         |  |     |     |     |  |     |     |     |     | | 
  | |--------------------------------------------------------------------------------         |  `-----------------'  |------------------     | | 
  | |        |     |     |     |     |     |     |     |     |     |     |     |     |        |                       |     |     |     |     | | 
  | |-----------------------------------------------------------------------------------------|        ,-----.        |-----------------------| | 
  | |           |     |     |     |     |     |     |     |     |     |     |     |           |        |     |        |     |     |     |     | | 
  | |-----------------------------------------------------------------------------------------|  ,-----------------.  |------------------     | | 
  | |      |     |      |     |                             |      |      |      |     |      |  |     |     |     |  |           |     |     | | 
  | `-----------------------------------------------------------------------------------------'  `-----------------'  `-----------------------' | 
  `---------------------------------------------------------------------------------------------------------------------------------------------' 
  [#] LAYOUT(
    _______,        _______,_______,_______,_______,    _______,_______,_______,_______,    _______,_______,_______,_______,   _______,_______,_______,
  
    _______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,   _______,_______,_______,   _______,_______,_______,_______,
    _______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,                   _______,_______,_______,   _______,_______,_______,
    _______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,        _______,                              _______,_______,_______,_______,
    _______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,        _______,           _______,           _______,_______,_______,
    _______,_______,_______,_______,         _______,   _______,   _______,         _______,_______,_______,_______,_______,   _______,_______,_______,   _______,        _______,_______), */
 

 
  /* -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
  // Base layer
  ,---------------------------------------------------------------------------------------------------------------------------------------------.
  | ,-----.     ,-----------------------.  ,-----------------------.  ,-----------------------.  ,-----------------.                            |
  | | ESC |     | F1  | F2  | F3  | F4  |  | F5  | F6  | F7  | F8  |  | F9  | F10 | F11 | F12 |  | PRS | SCL | PAU |                            |
  | `-----'     `-----------------------'  `-----------------------'  `-----------------------'  `-----------------'           O     O     O    |
  | ,-----------------------------------------------------------------------------------------.  ,-----------------.  ,-----------------------. |
  | | E/J |  1  |  2  |  3  |  4  |  5  |  6  |  7  |  8  |  9  |  0  |  -  |  ^  | JPY | BS  |  | INS |HOME | PGU |  | NUM |  /  |  *  |  -  | |
  | |-----------------------------------------------------------------------------------------|  |-----------------|  |-----------------------| |
  | |  TAB  |  Q  |  W  |  E  |  R  |  T  |  Y  |  U  |  I  |  O  |  P  |  @  |  [  |         |  | DEL | END | PGD |  |  7  |  8  |  9  |     | |
  | |--------------------------------------------------------------------------------    ENT  |  `-----------------'  |------------------  +  | |
  | |  CAPS  |  A  |  S  |  D  |  F  |  G  |  H  |  J  |  K  |  L  |  ;  |  :  |  ]  |        |                       |  4  |  5  |  6  |     | |
  | |-----------------------------------------------------------------------------------------|        ,-----.        |-----------------------| |
  | |  SHIFT    |  Z  |  X  |  C  |  V  |  B  |  N  |  M  |  ,  |  .  |  /  |  \  |  SHIFT    |        | UP  |        |  1  |  2  |  3  | ENT | |
  | |-----------------------------------------------------------------------------------------|  ,-----------------.  |------------------  /  | |
  | | CTRL | OS  | ALT  | MHN |            SPACE            | HENK | KANA | ALT  | FN  | CTRL |  |LEFT |DOWN |RIGHT|  |     0     |  .  | HEX | |
  | `-----------------------------------------------------------------------------------------'  `-----------------'  `-----------------------' |
  `---------------------------------------------------------------------------------------------------------------------------------------------' */
  [0] LAYOUT(
    KC_ESC,          KC_F1,  KC_F2,  KC_F3,  KC_F4,     KC_F5,  KC_F6,  KC_F7,  KC_F8,     KC_F9,  KC_F10,  KC_F11,  KC_F12,   KC_PSCR,KC_SLCK,KC_PAUS,  
  
    KC_ZKHK,KC_1,   KC_2,   KC_3,   KC_4,   KC_5,   KC_6,   KC_7,   KC_8,   KC_9,   KC_0,   KC_MINS,KC_EQL, KC_JYEN,KC_BSPC,   KC_INS, KC_HOME,KC_PGUP,   KC_NLCK,KC_PSLS,KC_PAST,KC_PMNS,
    KC_TAB, KC_Q,   KC_W,   KC_E,   KC_R,   KC_T,   KC_Y,   KC_U,   KC_I,   KC_O,   KC_P,   KC_LBRC,KC_RBRC,                   KC_DEL, KC_END, KC_PGDN,   KC_P7,  KC_P8,  KC_P9,  
    CAPS_FN,KC_A,   KC_S,   KC_D,   KC_F,   KC_G,   KC_H,   KC_J,   KC_K,   KC_L,   KC_SCLN,KC_QUOT,KC_BSLS,         KC_ENT,                              KC_P4,  KC_P5,  KC_P6,  KC_PPLS,  
    KC_LSFT,xxxxxxx,KC_Z,   KC_X,   KC_C,   KC_V,   KC_B,   KC_N,   KC_M,   KC_COMM,KC_DOT, KC_SLSH,KC_RO,          KC_RSFT,           KC_UP,             KC_P1,  KC_P2,  KC_P3,  
    KC_LCTL,KC_LGUI,KC_LALT,KC_MHEN,            xxxxxxx,KC_SPC,xxxxxxx,             KC_HENK,KC_KANA,KC_RALT,FN1_APP,KC_RCTL,   KC_LEFT,KC_DOWN,KC_RGHT,   KC_P0,          KC_PDOT,SHFTHEX),



  /* -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
  // HEX keypad layer
  ,---------------------------------------------------------------------------------------------------------------------------------------------.
  | ,-----.     ,-----------------------.  ,-----------------------.  ,-----------------------.  ,-----------------.                            |
  | |     |     |     |     |     |     |  |     |     |     |     |  |     |     |     |     |  |     |     |     |                            |
  | `-----'     `-----------------------'  `-----------------------'  `-----------------------'  `-----------------'           O     O     O    |
  | ,-----------------------------------------------------------------------------------------.  ,-----------------.  ,-----------------------. |
  | |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |  |     |     |     |  |     |     |     |     | |
  | |-----------------------------------------------------------------------------------------|  |-----------------|  |-----------------------| |
  | |       |     |     |     |     |     |     |     |     |     |     |     |     |         |  |     |     |     |  |  #  |  %  |  &  |     | |
  | |--------------------------------------------------------------------------------         |  `-----------------'  |------------------     | |
  | |        |     |     |     |     |     |     |     |     |     |     |     |     |        |                       |  D  |  E  |  F  |     | |
  | |-----------------------------------------------------------------------------------------|        ,-----.        |-----------------------| |
  | |           |     |     |     |     |     |     |     |     |     |     |     |           |        |     |        |  A  |  B  |  C  |     | |
  | |-----------------------------------------------------------------------------------------|  ,-----------------.  |------------------     | |
  | |      |     |      |     |                             |      |      |      |     |      |  |     |     |     |  |   SPACE   |  X  |     | |
  | `-----------------------------------------------------------------------------------------'  `-----------------'  `-----------------------' |
  `---------------------------------------------------------------------------------------------------------------------------------------------' */
  [1] LAYOUT(
    _______,        _______,_______,_______,_______,    _______,_______,_______,_______,    _______,_______,_______,_______,   _______,_______,_______,
  
    _______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,   _______,_______,_______,   KC_BSPC,_______,_______,_______,
    _______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,                   _______,_______,_______,   KC_HASH,KC_PERC,KC_AMPR,   
    _______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,        _______,                              HEXD,   HEXE,   HEXF,   _______,
    _______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,        _______,           _______,           HEXA,   HEXB,   HEXC,   
    _______,_______,_______,_______,         _______,   _______,   _______,         _______,_______,_______,_______,_______,   _______,_______,_______,   KC_SPC,         HEXX,   _______),



  /* -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
  // Game layer
  ,---------------------------------------------------------------------------------------------------------------------------------------------. 
  | ,-----.     ,-----------------------.  ,-----------------------.  ,-----------------------.  ,-----------------.                            | 
  | |     |     |     |     |     |     |  |     |     |     |     |  |     |     |     |     |  |     |     |     |                            | 
  | `-----'     `-----------------------'  `-----------------------'  `-----------------------'  `-----------------'           O     O     O    | 
  | ,-----------------------------------------------------------------------------------------.  ,-----------------.  ,-----------------------. | 
  | |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |  |     |     |     |  |     |     |     |     | | 
  | |-----------------------------------------------------------------------------------------|  |-----------------|  |-----------------------| | 
  | |       |     |     |     |     |     |     |     |     |     |     |     |     |         |  |     |     |     |  |     |     |     |     | | 
  | |--------------------------------------------------------------------------------         |  `-----------------'  |------------------     | | 
  | |        |     |     |     |     |     |     |     |     |     |     |     |     |        |                       |     |     |     |     | | 
  | |-----------------------------------------------------------------------------------------|        ,-----.        |-----------------------| | 
  | |           |     |     |     |     |     |     |     |     |     |     |     |           |        |     |        |     |     |     |     | | 
  | |-----------------------------------------------------------------------------------------|  ,-----------------.  |------------------     | | 
  | |      |     |      |     |                             |      |      |      |     |      |  |     |     |     |  |           |     |     | | 
  | `-----------------------------------------------------------------------------------------'  `-----------------'  `-----------------------' | 
  `---------------------------------------------------------------------------------------------------------------------------------------------' */ 
  [2] LAYOUT(
    _______,        _______,_______,_______,_______,    _______,_______,_______,_______,    _______,_______,_______,_______,   _______,_______,_______,
  
    KC_ESC, _______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,   _______,_______,_______,   _______,_______,_______,_______,
    _______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,                   _______,_______,_______,   _______,_______,_______,
    MO(12), _______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,        _______,                              _______,_______,_______,_______,
    _______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,        _______,           _______,           _______,_______,_______,
    _______,xxxxxxx,_______,KC_ENT,          _______,   _______,   _______,         KC_RALT,KC_RALT,_______,_______,_______,   _______,_______,_______,   _______,        _______,_______),



  /* -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
  // Mouse keypad layer
  ,---------------------------------------------------------------------------------------------------------------------------------------------.
  | ,-----.     ,-----------------------.  ,-----------------------.  ,-----------------------.  ,-----------------.                            |
  | |     |     |     |     |     |     |  |     |     |     |     |  |     |     |     |     |  |     |     |     |                            |
  | `-----'     `-----------------------'  `-----------------------'  `-----------------------'  `-----------------'           O     O     O    |
  | ,-----------------------------------------------------------------------------------------.  ,-----------------.  ,-----------------------. |
  | |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |  |     |     |     |  |     |     |     |     | |
  | |-----------------------------------------------------------------------------------------|  |-----------------|  |-----------------------| |
  | |       |     |     |     |     |     |     |     |     |     |     |     |     |         |  |     |     |     |  |  #  |  %  |  &  |     | |
  | |--------------------------------------------------------------------------------         |  `-----------------'  |------------------     | |
  | |        |     |     |     |     |     |     |     |     |     |     |     |     |        |                       |  D  |  E  |  F  |     | |
  | |-----------------------------------------------------------------------------------------|        ,-----.        |-----------------------| |
  | |           |     |     |     |     |     |     |     |     |     |     |     |           |        |     |        |  A  |  B  |  C  |     | |
  | |-----------------------------------------------------------------------------------------|  ,-----------------.  |------------------     | |
  | |      |     |      |     |                             |      |      |      |     |      |  |     |     |     |  |   SPACE   |  X  |     | |
  | `-----------------------------------------------------------------------------------------'  `-----------------'  `-----------------------' |
  `---------------------------------------------------------------------------------------------------------------------------------------------' */
  [3] LAYOUT(
    _______,        _______,_______,_______,_______,    _______,_______,_______,_______,    _______,_______,_______,_______,   _______,_______,_______,
  
    _______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,   _______,_______,_______,   xxxxxxx,KC_WH_L,KC_WH_R,KC_BTN3,
    _______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,                   _______,_______,_______,   KC_BTN1,KC_MS_U,KC_BTN2,   
    _______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,        _______,                              KC_MS_L,KC_MS_D,KC_MS_R,KC_WH_U,
    _______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,        _______,           _______,           xxxxxxx,KC_MS_D,xxxxxxx, 
    _______,_______,_______,_______,         _______,   _______,   _______,         _______,_______,_______,_______,_______,   _______,_______,_______,   KC_BTN1,        KC_BTN2,KC_WH_D),

 

 /* -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
  // Function layer 1
  ,---------------------------------------------------------------------------------------------------------------------------------------------.
  | ,-----.     ,-----------------------.  ,-----------------------.  ,-----------------------.  ,-----------------.                            |
  | |     |     | PF1 | PF2 |     |     |  |     |     |     |     |  |     |     |     |     |  |     |     |     |                            |
  | `-----'     `-----------------------'  `-----------------------'  `-----------------------'  `-----------------'           O     O     O    |
  | ,-----------------------------------------------------------------------------------------.  ,-----------------.  ,-----------------------. |
  | |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |  |     |     |     |  |     |     |     |     | |
  | |-----------------------------------------------------------------------------------------|  |-----------------|  |-----------------------| |
  | |       |     |     |     |     |     |     |     |     |     |     |     |     |         |  |     |     |     |  |     |     |     |     | |
  | |--------------------------------------------------------------------------------         |  `-----------------'  |------------------     | |
  | |        |     |     |     |     |     |     |     |     |     |     |     |     |        |                       |     |     |     |     | |
  | |-----------------------------------------------------------------------------------------|        ,-----.        |-----------------------| |
  | |           |     |     |     |     |     |     |     | LR2 |     |     |     |           |        |     |        |     |     |     |     | |
  | |-----------------------------------------------------------------------------------------|  ,-----------------.  |------------------     | |
  | |      |     |      |     |                             |      |      | MENU |     |      |  |     |     |     |  |           |     |     | |
  | `-----------------------------------------------------------------------------------------'  `-----------------'  `-----------------------' |
  `---------------------------------------------------------------------------------------------------------------------------------------------' */
  [10] LAYOUT(
    _______,        DM_PLY1,DM_PLY2,_______,_______,    _______,_______,_______,_______,    _______,_______,EEPROMR,EEPROMW,   _______,_______,_______,
  
    SW_BOTH,SW_LEFT,SW_RGHT,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,   _______,_______,_______,   _______,_______,_______,TG(3),
    _______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,                   _______,_______,_______,   _______,_______,_______,
    _______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,        _______,                              _______,_______,_______,_______,
    _______,_______,_______,_______,_______,_______,_______,_______,MO(13), _______,_______,_______,_______,        _______,           _______,           _______,_______,_______,
    _______,TG(2),  _______,_______,         _______,   _______,   _______,         _______,_______,KC_APP, _______,_______,   _______,_______,_______,   _______,        _______,_______),


  /* -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
  // Function layer 2
  ,---------------------------------------------------------------------------------------------------------------------------------------------.
  | ,-----.     ,-----------------------.  ,-----------------------.  ,-----------------------.  ,-----------------.                            |
  | |     |     | PF1 | PF2 |     |     |  |     |     |     |     |  |     |     |     |     |  |     |     |     |                            |
  | `-----'     `-----------------------'  `-----------------------'  `-----------------------'  `-----------------'           O     O     O    |
  | ,-----------------------------------------------------------------------------------------.  ,-----------------.  ,-----------------------. |
  | |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |  |     |     |     |  |     |     |     |     | |
  | |-----------------------------------------------------------------------------------------|  |-----------------|  |-----------------------| |
  | |       |HOME | UP  | END |     |     |     |     |     |     |     |     |     |         |  |     |     |     |  |     |     |     |     | |
  | |--------------------------------------------------------------------------------         |  `-----------------'  |------------------     | |
  | |        |LEFT |DOWN |RIGHT|     |     |     |     |     |     |     |     |     |        |                       |     |     |     |     | |
  | |-----------------------------------------------------------------------------------------|        ,-----.        |-----------------------| |
  | |           | BS  | DEL | INS |     |     |     |     | LR2 |     |     |     |           |        |     |        |     |     |     |     | |
  | |-----------------------------------------------------------------------------------------|  ,-----------------.  |------------------     | |
  | |      |     |      |     |                             |      |      | MENU |     |      |  |     |     |     |  |           |     |     | |
  | `-----------------------------------------------------------------------------------------'  `-----------------'  `-----------------------' |
  `---------------------------------------------------------------------------------------------------------------------------------------------' */
  [11] LAYOUT(
    _______,        DM_PLY1,DM_PLY2,_______,_______,    _______,_______,_______,_______,    _______,_______,_______,_______,   _______,_______,_______,
  
    SW_BOTH,SW_LEFT,SW_RGHT,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,   _______,_______,_______,    xxxxxxx,KC_WH_L,KC_WH_R,KC_BTN3,
    _______,KC_HOME,KC_UP,  KC_END, _______,_______,_______,_______,_______,_______,_______,_______,_______,                   _______,_______,_______,    KC_BTN1,KC_MS_U,KC_BTN2,        
    _______,KC_LEFT,KC_DOWN,KC_RGHT,_______,_______,_______,_______,_______,_______,_______,_______,_______,        _______,                               KC_MS_L,KC_MS_D,KC_MS_R,KC_WH_U,
    _______,KC_BSPC,KC_DEL, KC_INS, _______,_______,_______,_______,MO(13), _______,_______,_______,_______,        _______,           _______,            xxxxxxx,KC_MS_D,xxxxxxx,        
    _______,_______,_______,_______,         _______,   KC_ENT,    _______,         _______,_______,KC_APP, _______,_______,   _______,_______,_______,    KC_BTN1,        KC_BTN2,KC_WH_D),


  /* -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
  // Function layer 3
  ,---------------------------------------------------------------------------------------------------------------------------------------------.
  | ,-----.     ,-----------------------.  ,-----------------------.  ,-----------------------.  ,-----------------.                            |
  | |     |     | PF1 | PF2 |     |     |  |     |     |     |     |  |     |     |     |     |  |     |     |     |                            |
  | `-----'     `-----------------------'  `-----------------------'  `-----------------------'  `-----------------'           O     O     O    |
  | ,-----------------------------------------------------------------------------------------.  ,-----------------.  ,-----------------------. |
  | |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |  |     |     |     |  |     |     |     |     | |
  | |-----------------------------------------------------------------------------------------|  |-----------------|  |-----------------------| |
  | |       |HOME | UP  | END |     |     |     |     |     |     |     |     |     |         |  |     |     |     |  |     |     |     |     | |
  | |--------------------------------------------------------------------------------         |  `-----------------'  |------------------     | |
  | |        |LEFT |DOWN |RIGHT|     |     |     |     |     |     |     |     |     |        |                       |     |     |     |     | |
  | |-----------------------------------------------------------------------------------------|        ,-----.        |-----------------------| |
  | |           | BS  | DEL | INS |     |     |     |     | LR2 |     |     |     |           |        |     |        |     |     |     |     | |
  | |-----------------------------------------------------------------------------------------|  ,-----------------.  |------------------     | |
  | |      |     |      |     |          ENTER              |      |      | MENU |     |      |  |     |     |     |  |           |     |     | |
  | `-----------------------------------------------------------------------------------------'  `-----------------'  `-----------------------' |
  `---------------------------------------------------------------------------------------------------------------------------------------------' */
  [12] LAYOUT(
    _______,        DM_PLY1,DM_PLY2,_______,_______,    _______,_______,_______,_______,    _______,_______,_______,_______,   _______,_______,_______,
  
    _______,KC_6,   KC_7,   KC_8,   KC_9,   KC_0,   _______,_______,_______,_______,_______,_______,_______,_______,_______,   _______,_______,_______,   _______,_______,_______,_______,
    _______,KC_Y,   KC_U,   KC_I,   KC_O,   KC_P,   _______,_______,_______,_______,_______,_______,_______,                   _______,_______,_______,   _______,_______,_______,
    _______,KC_H,   KC_J,   KC_K,   KC_L,   _______,_______,_______,_______,_______,_______,_______,_______,        _______,                              _______,_______,_______,_______,
    _______,xxxxxxx,KC_B,   KC_N,   KC_M,   _______,_______,_______,MO(13), _______,_______,_______,_______,        _______,           _______,           _______,_______,_______,
    SAFECAP,_______,_______,_______,         _______,   KC_ENT,    _______,         _______,_______,KC_APP, _______,_______,   _______,_______,_______,   _______,        _______,_______),
  

/* -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
  // Macro record layer 
  ,---------------------------------------------------------------------------------------------------------------------------------------------.
  | ,-----.     ,-----------------------.  ,-----------------------.  ,-----------------------.  ,-----------------.                            |
  | |STOP |     |REC_1|REC_2|     |     |  |     |     |     |     |  |     |     |     |     |  |     |     |     |                            |
  | `-----'     `-----------------------'  `-----------------------'  `-----------------------'  `-----------------'           O     O     O    |
  | ,-----------------------------------------------------------------------------------------.  ,-----------------.  ,-----------------------. |
  | |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |  |     |     |     |  |     |     |     |     | |
  | |-----------------------------------------------------------------------------------------|  |-----------------|  |-----------------------| |
  | |       |     |     |     |     |     |     |     |     |     |     |     |     |         |  |     |     |     |  |     |     |     |     | |
  | |--------------------------------------------------------------------------------         |  `-----------------'  |------------------     | |
  | |        |     |     |     |     |     |     |     |     |     |     |     |     |        |                       |     |     |     |     | |
  | |-----------------------------------------------------------------------------------------|        ,-----.        |-----------------------| |
  | |           |     |     |     |     |     |     |     |     |     |     |     |           |        |     |        |     |     |     |     | |
  | |-----------------------------------------------------------------------------------------|  ,-----------------.  |------------------     | |
  | |      |     |      |     |                             |      |      |      |     |      |  |     |     |     |  |           |     |     | |
  | `-----------------------------------------------------------------------------------------'  `-----------------'  `-----------------------' |
  `---------------------------------------------------------------------------------------------------------------------------------------------' */
  [13] LAYOUT(
    DM_STOP,        DM_REC1,DM_REC2,_______,_______,    _______,_______,_______,_______,    _______,_______,_______,_______,   _______,_______,_______,
  
    _______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,   _______,_______,_______,   _______,_______,_______,_______,
    _______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,                   _______,_______,_______,   _______,_______,_______,
    _______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,        _______,                              _______,_______,_______,_______,
    _______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,_______,        _______,           _______,           _______,_______,_______,
    _______,_______,_______,_______,         _______,   _______,   _______,         _______,_______,_______,_______,_______,   _______,_______,_______,   _______,        _______,_______),

};

// Animation tables
  static const uint16_t blinking_table[64] PROGMEM = {
    255, 255, 255, 255, 255, 255, 255, 200, 100, 75,  50,  25,  10,  5,   0,   0,
    255, 255, 255, 255, 255, 255, 255, 200, 100, 75,  50,  25,  10,  5,   0,   0,
    255, 255, 255, 255, 255, 255, 255, 200, 100, 75,  50,  25,  10,  5,   0,   0,
    255, 255, 255, 255, 255, 255, 255, 200, 100, 75,  50,  25,  10,  5,   0,   0
  };
  static const uint16_t load_left_table[64] PROGMEM = {
    0,   0,   0,   0,   0,   0,   5,   10,  25,  50,  75,  100, 150, 200, 255, 255, 
    255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
    255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
    255, 255, 255, 255, 255, 255, 255, 255, 200, 100, 75,  50,  25,  10,  5,   0  
  };
  static const uint16_t load_center_table[64] PROGMEM = {
    0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,  
    0,   0,   0,   0,   0,   0,   5,   10,  25,  50,  75,  100, 150, 200, 255, 255, 
    255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
    255, 255, 255, 255, 255, 255, 255, 255, 200, 100, 75,  50,  25,  10,  5,   0  
  };
  static const uint16_t load_right_table[64] PROGMEM = {
    0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,  
    0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,  
    0,   0,   0,   0,   0,   0,   5,   10,  25,  50,  75,  100, 150, 200, 255, 255, 
    255, 255, 255, 255, 255, 255, 255, 255, 200, 100, 75,  50,  25,  10,  5,   0  
  };
  static const uint16_t unload_right_table[64] PROGMEM = {
    200, 100, 75,  50,  25,  10,  5,   0,   0,   0,   0,   0,   0,   0,   0,   0,  
    0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,  
    0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,  
    0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0  
  };
  static const uint16_t unload_center_table[64] PROGMEM = {
    255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
    200, 100, 75,  50,  25,  10,  5,   0,   0,   0,   0,   0,   0,   0,   0,   0,  
    0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,  
    0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0  
  };
  static const uint16_t unload_left_table[64] PROGMEM = {
    255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
    255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
    200, 100, 75,  50,  25,  10,  5,   0,   0,   0,   0,   0,   0,   0,   0,   0,  
    0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0  
  };

// PWM timer
ISR(TIMER1_COMPA_vect) {
  static union {
    uint16_t row;
      struct {
        uint8_t count:8;
        uint8_t duration:1;
        uint8_t index:6;
      } pwm;
  } 
  timer = { .row = 0 };
  timer.row++;

  if (keypad_led_animation) {
    if (timer.pwm.count == 0 && pgm_read_byte(&blinking_table[timer.pwm.index]) != 0 )
      { led_on(keypad_led); }
    if (pgm_read_byte(&blinking_table[timer.pwm.index]) == timer.pwm.count || timer.pwm.count == pgm_read_byte(&blinking_table[timer.pwm.index]))
      { led_off(keypad_led); }
  }
  if (caps_led_animation) {
    if (timer.pwm.count == 0 && pgm_read_byte(&blinking_table[timer.pwm.index]) != 0 )
      { led_on(caps_led); }
    if (pgm_read_byte(&blinking_table[timer.pwm.index]) == timer.pwm.count || timer.pwm.count == pgm_read_byte(&blinking_table[timer.pwm.index]))
      { led_off(caps_led); }
  }
  if (fn_led_animation) {
    if (timer.pwm.count == 0 && pgm_read_byte(&blinking_table[timer.pwm.index]) != 0 )
      { led_on(fn_led); }
    if (pgm_read_byte(&blinking_table[timer.pwm.index]) == timer.pwm.count || timer.pwm.count == pgm_read_byte(&blinking_table[timer.pwm.index]))
      { led_off(fn_led); }
  }
  if (load_led_animation) {
    if (load_animation_counter == 0) {  timer.row = 0; }    
    if (timer.pwm.count == 0 && pgm_read_byte(&load_left_table[timer.pwm.index]) != 0)
      { led_on(left_led); }
    if (timer.pwm.count == pgm_read_byte(&load_left_table[timer.pwm.index]))
      { led_off(left_led); }
    if (timer.pwm.count == 0 && pgm_read_byte(&load_center_table[timer.pwm.index]) != 0)
      { led_on(center_led); }
    if (timer.pwm.count == pgm_read_byte(&load_center_table[timer.pwm.index]))
      { led_off(center_led); }
    if (timer.pwm.count == 0 && pgm_read_byte(&load_right_table[timer.pwm.index]) != 0)
      { led_on(right_led); }
    if (timer.pwm.count == pgm_read_byte(&load_right_table[timer.pwm.index]))
      { led_off(right_led); }
    load_animation_counter++;
    if (load_animation_counter >= 32500) {
      load_animation_counter = 0;
      load_led_animation = false;
      led_off(left_led);
      led_off(center_led);
      led_off(right_led);
    }
  }
  if (unload_led_animation) {
    if (unload_animation_counter == 0) {  timer.row = 0; }    
    if (timer.pwm.count == 0 && pgm_read_byte(&unload_left_table[timer.pwm.index]) != 0)
      { led_on(left_led); }
    if (timer.pwm.count == pgm_read_byte(&unload_left_table[timer.pwm.index]))
      { led_off(left_led); }
    if (timer.pwm.count == 0 && pgm_read_byte(&unload_center_table[timer.pwm.index]) != 0)
      { led_on(center_led); }
    if (timer.pwm.count == pgm_read_byte(&unload_center_table[timer.pwm.index]))
      { led_off(center_led); }
    if (timer.pwm.count == 0 && pgm_read_byte(&unload_right_table[timer.pwm.index]) != 0)
      { led_on(right_led); }
    if (timer.pwm.count == pgm_read_byte(&unload_right_table[timer.pwm.index]))
      { led_off(right_led); }
    unload_animation_counter++;
    if (unload_animation_counter >= 32500) {
      unload_animation_counter = 0;
      unload_led_animation = false;
      led_off(left_led);
      led_off(center_led);
      led_off(right_led);
    }
  }
}


char eepromstring[10];
uint8_t ee_str;
int a;
bool process_record_user(uint16_t keycode, keyrecord_t *record) {
  if (!process_record_dynamic_macro(keycode, record)) {
    return false;
  }
  if (record->event.pressed) {
    switch (keycode) {
      case EEPROMW:
        if (record->event.pressed) {
           // Write 0x80 (128) to EEPROM locations 2047-2176 for testing
           /* 
	   for( a = 2047; a < 2176; a = a + 1 ){
             eeprom_write_byte((uint8_t*)a, 0x80);
           } 
           */
        }
      return false;
      case EEPROMR:
        if (record->event.pressed) {
          // Read EEPROM locations 2047-2176 into a macro for testing
	  for( a = 2047; a < 2176; a = a + 1 ){
            ee_str = eeprom_read_byte((uint8_t*)a);
            sprintf( eepromstring, "%d", ee_str );
            send_string(eepromstring);
          }
        }
      return false;
      case MS_K_UL:
        if (record->event.pressed) {
            mousekey_on(KC_MS_L);
            mousekey_on(KC_MS_U);

        }
            mousekey_off(KC_MS_L);
            mousekey_off(KC_MS_U);
      return false;
      case HEXD:
        if (record->event.pressed) {
          SEND_STRING("D");
        }
      return false;
      case HEXE:
        if (record->event.pressed) {
          SEND_STRING("E");
        }  
      return false;
      case HEXF:
        if (record->event.pressed) {
          SEND_STRING("F");
        }
      return false;
      case HEXA:
        if (record->event.pressed) {
          SEND_STRING("A");
        }
      return false;
      case HEXB:
        if (record->event.pressed) {
          SEND_STRING("B");
        }
      return false;
      case HEXC:
        if (record->event.pressed) {
          SEND_STRING("C");
        }
      return false;
      case HEXX:
        if (record->event.pressed) {
          SEND_STRING("x");
        }
      return false;
      case SW_LEFT: // Toggle on/off transistor on E7 to "click" external monitor input switching button
        if (record->event.pressed) {
          DDRE |=  (1<<7); PORTE |=  (1<<7);
          wait_ms(20);
          DDRE &= ~(1<<7); PORTE &= ~(1<<7);
        }
      return false;
      case SW_RGHT: // Toggle on/off transistor on E6 to "click" external monitor input switching button
        if (record->event.pressed) {
          DDRE |=  (1<<6); PORTE |=  (1<<6);
          wait_ms(20);
          DDRE &= ~(1<<6); PORTE &= ~(1<<6);
        }
      return false;
      case SW_BOTH: // Toggle on/off transistors on E6 and E7 to "click" external monitor input switching button
        if (record->event.pressed) {
          DDRE |=  (1<<6); PORTE |=  (1<<6);
          DDRE |=  (1<<7); PORTE |=  (1<<7);
          wait_ms(20);
          DDRE &= ~(1<<6); PORTE &= ~(1<<6);
          DDRE &= ~(1<<7); PORTE &= ~(1<<7);
        }
      return false;
     }
  }
  return true;
}

void matrix_init_user(void) {
  load_led_animation = true;

}

void matrix_scan_user(void) {

}

void led_set_user(uint8_t usb_led) {
  if ((1<<1 & layer_state) != 0 || (1<<3 & layer_state) != 0) {
    if ((1<<1 & layer_state) !=0) {
      keypad_led_animation = true;
    }
    else if ((1<<3 & layer_state) !=0) {
      keypad_led_animation = false;
      led_on(keypad_led);
    }
  }
  else {
    keypad_led_animation = false;
    led_off(keypad_led);
  }
  if ((1<<2 & layer_state) != 0) {
    led_on(meta_led);
  }
  else {
    led_off(meta_led);
  }
  if ((1<<10 & layer_state) != 0) {
    fn_led_animation = true;
  }
  else {
    fn_led_animation = false;
    led_off(fn_led);
  }
  if ((1<<11 & layer_state) != 0 || (1<<12 & layer_state) != 0 || usb_led & (1<<USB_LED_CAPS_LOCK)) {
    if ((1<<11 & layer_state) !=0 || (1<<12 & layer_state) !=0 ) {
      caps_led_animation = true;
    }
    else if (usb_led & (1<<USB_LED_CAPS_LOCK)) {
      caps_led_animation = false;
      led_on(caps_led);
    }
  }
  else {
    caps_led_animation = false;
    led_off(caps_led);
  }
  if ((1<<13 & layer_state) != 0) {
    unload_led_animation_start = true;
    led_on(left_led);
    led_on(center_led);
    led_on(right_led);
  }
  else if (unload_led_animation_start) {
    unload_led_animation = true;
    unload_led_animation_start = false;
  }
  if (usb_led & (1<<USB_LED_NUM_LOCK) && (1<<3 & layer_state) == 0) {
    led_on(num_led);
  }
  else {
    led_off(num_led);
  }
  if (usb_led & (1<<USB_LED_SCROLL_LOCK)) {
    led_on(scroll_led);
  }
  else {
    led_off(scroll_led);
  }
}
